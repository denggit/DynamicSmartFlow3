# 猎手挖掘完整流程：从热门代币到猎手入库

## 模式说明

| 模式 | 环境变量 | 挖掘方式 | 数据目录 | 说明 |
|------|----------|----------|----------|------|
| **MODELA** | `HUNTER_MODE=MODELA`（默认） | 高收益 token 挖掘：DexScreener 热门币 → 回溯早期买家 | `data/modelA/` | hunters.json、scanned_tokens.json、wallet_blacklist.json |
| **MODELB** | `HUNTER_MODE=MODELB` | SM 榜单挖掘：`wallets.txt` 手动导入 GMGN 钱包 → 逐个分析 | `data/modelB/` | wallets.txt、smart_money.json、trash_wallets.txt |

配置方式：在 `.env` 中设置 `HUNTER_MODE=MODELB` 切换到 MODELB。

---

## 一、触发与入口

### MODELA

- **入口**：`HunterMonitorController.discovery_loop()` 定时循环（默认每 15 分钟）
- **调用**：`sm_searcher.run_pipeline(dex_scanner)` → 返回符合条件的猎手列表
- **入库**：`storage.prune_and_update(new_hunters)` → 写入 `data/modelA/hunters.json`

### MODELB

- **入口**：同上 `discovery_loop`，调用 `sm_searcher_b.run_pipeline()`
- **输入**：`data/modelB/wallets.txt`，每行一个 Solana 地址
- **输出**：合格猎手写入 `data/modelB/smart_money.json`，垃圾钱包追加到 `data/modelB/trash_wallets.txt`
- **去重**：启动时读取 smart_money.json 和 trash_wallets.txt 跳过已分析地址；分析完成后从 wallets.txt 移除该地址，避免重复分析
- **逻辑**：跳过已入库、已 trash 的地址；库满 100 时高分替换低分；复用 MODELA 的高频、LP 检测
- **分析**：`services/modelb_analyzer.py` 三维度统计（盈利力/持久力/真实性）
- **评分**：`utils/scoring/modelb.py` 三维度评分，与 MODELA 完全分离

---

## 二、阶段 1：获取热门代币（DexScreener，仅 MODELA）

### 2.1 拉取代币列表

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `GET https://api.dexscreener.com/token-profiles/latest/v1` | DexScreener |
| 2 | 得到「最近有社交信息更新」的代币列表 | |
| 3 | 只保留 `chainId == "solana"` 的代币 | |

### 2.2 逐一代币二次过滤

对每个代币执行：

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `GET https://api.dexscreener.com/latest/dex/tokens/{代币地址}` | DexScreener |
| 2 | 取 `pairs` 中流动性最大的 pair 作为 `main_pair` | |
| 3 | 读取：`liquidity.usd`、`volume.h1`、`pricePercentChange24h`（或 `priceChange.h24`） | |

### 2.3 过滤条件（全部满足才通过）

| 条件 | 配置 | 说明 |
|------|------|------|
| 流动性 ≥ | `DEX_MIN_LIQUIDITY_USD` (10000) | 池子至少 1 万 USD |
| 1h 成交量 ≥ | `DEX_MIN_VOL_1H_USD` (50000) | 1 小时成交至少 5 万 USD |
| 24h 涨幅 | 流动性筛选阶段不再过滤 | 由 sm_searcher 结合年龄判断：年龄在范围内且涨幅达标才挖；涨幅未达标不写 scanned，下次重试 |

### 2.4 输出

通过筛选的代币列表 `hot_tokens`，每个包含：`address`、`symbol`、`liquidity`、`vol_1h`、`gain_24h_pct`。

---

## 三、阶段 2：对每个热门代币挖掘猎手

对 `hot_tokens` 中的每个代币（跳过 `scanned_tokens` 中的）执行 `search_alpha_hunters(token_address)`。

### 3.1 代币年龄检查（DexScreener）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `GET https://api.dexscreener.com/latest/dex/tokens/{代币地址}` | DexScreener |
| 2 | 取主交易对（流动性最高）的 `pairCreatedAt` → `start_time`（不取 min，因 Pump.fun bonding 创建最早会误判为超龄） | |
| 3 | `age = now - start_time` | |

| 条件 | 配置 | 不满足时 |
|------|------|----------|
| `age < MIN` | `MIN_TOKEN_AGE_SEC` | 跳过，不写入 `scanned_tokens` |
| `age > MAX` | `MAX_TOKEN_AGE_SEC` | 跳过，写入 `scanned_tokens`（超龄不再考虑） |
| `age` 在范围内但 `涨幅 < DEX_MIN_24H_GAIN_PCT` | - | 跳过，**不**写入 `scanned_tokens`（可能尚未涨起来，下次发现周期重试） |
| `age` 在范围内且涨幅达标 | - | 执行猎手挖掘，完成后写入 `scanned_tokens` |

### 3.2 回溯代币早期交易（Helius RPC）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `getSignaturesForAddress(代币地址, limit=1000)` | Helius RPC |
| 2 | 时间窗口：`[start_time, start_time + SM_MAX_DELAY_SEC]`（约 3 小时） | |
| 3 | 若本页最老交易 `> 窗口结束`，用 `before=最后一条 signature` 继续翻页 | |
| 4 | 最多翻 `MAX_BACKTRACK_PAGES` (30) 页 | |
| 5 | 收集窗口内所有交易签名 → `found_early_txs` | |
| 6 | 按时间排序，取前 `SM_EARLY_TX_PARSE_LIMIT` (300) 笔 → `target_txs` | |

### 3.3 解析早期交易（Helius API）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `POST https://api.helius.xyz/v0/transactions`，每批最多 100 笔 | Helius |
| 2 | 得到 `nativeTransfers`、`tokenTransfers` 等解析后的交易 | |

### 3.4 LP 初筛 + 初筛买家

**LP 初筛（优先）**：遍历解析后的早期交易，若 `tx_is_any_lp_behavior(tx)`，收集该交易中所有参与者地址（`nativeTransfers`/`tokenTransfers` 的 from/to）→ `lp_participants`。任何 LP 参与者绝不作为猎手候选人。

对每笔交易：

| 步骤 | 操作 |
|------|------|
| 1 | `delay = blockTime - start_time`，`delay < 15` 秒则跳过 |
| 2 | 合并 `nativeTransfers` + `tokenTransfers`(WSOL 转出) + USDC 转出（按 DexScreener 现价折算 SOL），统计每个 `fromUserAccount` 的 SOL 等价支出 |
| 3 | 取支出最多的地址为买家，`spend_sol = 支出 SOL` |
| 4 | 若 `spender in lp_participants` → **跳过**（LP 参与者绝不入库） |
| 5 | 若 `0.1 ≤ spend_sol ≤ 50` 且该地址未出现过 → 加入 `hunters_candidates` |
| 6 | 每个地址只计第一次出现（`seen_buyers` 去重） |

输出：`hunters_candidates`，每项含 `address`（`entry_delay`、`cost` 仅用于初筛，不入库）。

---

## 四、阶段 3：收益过滤 + 频率检测 + 评分（生产者-消费者）

对 `hunters_candidates` 中每个地址依次处理，一次拉取、多步复用。

### 4.1 LP 检测优先 + 频率预检 + 精准制导（ATA）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | **LP 检测优先**：`getSignaturesForAddress(猎手主钱包, limit=100)` → `fetch_parsed_transactions` | Alchemy + Helius |
| 2 | `hunter_had_any_lp_anywhere` / `hunter_had_any_lp_on_token`：有任意 LP（加池/撤池）→ **拉黑**，永不跟仓 | 本地 |
| 3 | LP 通过后，`_is_frequent_trader_by_blocktimes(sigs)`：失败率 ≥30% / 成功交易 < 10 笔 / 平均间隔 < 5 分钟 → 否决 | 本地 |
| 4 | `get_associated_token_address(猎手, token_mint)` 本地推导 ATA 地址 | 本地（无需 RPC） |
| 5 | `getSignaturesForAddress(ATA 地址, limit=50)` | Alchemy RPC |
| 6 | `fetch_parsed_transactions(ATA 签名)`：通常仅 2~10 笔，100% 为该代币 | Helius API |
| 7 | ROI 计算；若未达标 → 直接淘汰；达标则复用主钱包 100 笔供体检（不足 300 时再补拉） | |

**成本**：LP 检测 100 笔 + ATA 2~10 笔；LP 通过后主钱包数据复用，不重复拉取。

### 4.2 ROI 计算（软门槛）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | 从 ATA 交易中汇总 `buy_sol`、`sell_sol`、`tokens_held` | |
| 2 | 未清仓时：`_get_token_price_sol(代币)` 取现价，`总价值 = sell_sol + tokens_held × 现价` | DexScreener |
| 3 | `ROI = (总价值 - buy_sol) / buy_sol × 100` | |
| 4 | 入库门槛：≥100% 进评分池；<100% 或 `buy_sol < 0.01` → 直接淘汰 | |

**ROI 评分乘数**：
- **入库时**：用该代币入库时的 ROI → ≥200%×1，100%~200%×0.9
- **体检时**：用最近 30 天最大收益率 → ≥200%×1，100%~200%×0.9，50~100%×0.75（<50% 直接踢出）

### 4.3 体检评分

| 步骤 | 操作 |
|------|------|
| 1 | `analyze_hunter_performance(client, 猎手)`：ATA 模式返回 `pre_fetched_txs=None`，体检自行拉取 500 笔主钱包交易 |
| 2 | 排除当前代币，按其他代币汇总买入/卖出 |
| 3 | 只保留买入成本 > 0.05 SOL 的项目，全部用于评分（不限定 15 个） |
| 4 | `win_rate` = 盈利项目数 / 总项目数 |
| 5 | `total_profit` = 总利润 (SOL) |
| 6 | `avg_roi_pct` = 平均盈利率 (%) |
| 7 | `pnl_ratio` = 盈利单利润和 / 亏损单亏损和 |
| 8 | `max_roi_30d` / `max_roi_60d` = 最近 30/60 天内单笔最大 ROI % |

### 4.4 评分公式

评分逻辑按模式分离：`utils/scoring/modela.py`（MODELA）、`utils/scoring/modelb.py`（MODELB）。体检时按 `HUNTER_MODE` 自动选用对应 scorer。

**MODELA**（高收益 token 挖掘）：
```
胜率分 H (30%)：< 15% 零分，15%~35% 线性 0.5~1，≥35% 满分
盈利分 P (40%)：avg_roi_pct < 20% 零分，20%~60% 线性，≥60% 满分
盈亏比分 R (30%)：总盈亏比 < 1.5 零分，1.5~3 线性，> 3 满分
基础分 = H×30 + P×40 + R×30
最终分数 = 基础分 × ROI乘数（见 4.2）
scores_detail 格式：H:x.xx/P:x.xx/R:x.xx
```

**MODELB**（GMGN 榜单，三维度）：
```
盈利力 45 分：盈亏比 25 分 + 单币 ROI 平均 10 分 + 单币 ROI 最大 10 分；单币最大亏损>99% 扣 10 分
持久力 35 分：胜率 30 分（40%~80% 线性）+ 活跃度 5 分（日均≥1 满分）+ 灰尘占比扣分（>50% 扣 20，10~50% 线性扣 5~20）
真实性 20 分：平均持仓≤24h 5 分 + 盈利持仓>2×亏损持仓 10 分 + 已清仓占比（>90% 5 分 / >70% 3 分 / >50% 1 分）
scores_detail 格式：盈:x.x/持:x.x/真:x.x
入库门槛：总分≥SM_MODELB_ENTRY_MIN_SCORE (30) 且 总盈利>0
体检门槛：SM_MODELB_AUDIT_MIN_PNL_RATIO、SM_MODELB_AUDIT_MIN_WIN_RATE、SM_MODELB_AUDIT_KICK_MAX_ROI_30D_PCT
```

### 4.5 入库条件（硬门槛，全部满足）

| 条件 | 配置 |
|------|------|
| 总盈亏比 ≥ 2 | `SM_ENTRY_MIN_PNL_RATIO` |
| 胜率 ≥ 20% | `SM_ENTRY_MIN_WIN_RATE` |
| 有效交易代币数 ≥ 10 | `SM_ENTRY_MIN_TRADE_COUNT` |
| 总盈利 > 0 | - |

满足条件的加入 `verified_hunters`，并写入 `max_roi_30d`（入库当天记为当前代币 ROI）。

### 4.6 标记已扫描

| 步骤 | 操作 |
|------|------|
| 1 | 将代币地址写入 `data/scanned_tokens.json` |
| 2 | 下次挖掘时跳过该代币 |

---

## 五、阶段 4：汇总与过滤

| 步骤 | 操作 |
|------|------|
| 1 | 合并所有代币的 `verified_hunters` → `all_hunters` |
| 2 | 按分数从高到低排序 |
| 3 | 不再按最低分硬过滤，满足入库硬门槛即可进入 |
| 4 | 返回给 `HunterMonitorController` |

---

## 六、阶段 5：猎手入库（HunterStorage）

| 步骤 | 操作 |
|------|------|
| 1 | 清理僵尸：`last_active` 距现在超过 `ZOMBIE_THRESHOLD` (15 天) 的删除 |
| 2 | 对每个新猎手，满足入库四硬门槛即可（盈亏比≥2、胜率≥20%、代币数≥10、总盈利>0） |
| 3 | 若地址已存在 → 更新信息，保留原 `last_audit` |
| 4 | 若库未满 (`len < POOL_SIZE_LIMIT` 100) → 直接入库 |
| 5 | 若库已满 → 与分数最低者 PK，高分替换低分 |
| 6 | 写入 `data/hunters.json`，含 `max_roi_30d` |

---

## 七、数据流与 API 消耗概览

```
DexScreener
  token-profiles/latest     → 代币列表
  /latest/dex/tokens/{addr} → 流动性/成交量/24h涨幅、代币年龄、现价

Helius RPC
  getSignaturesForAddress(代币) → 代币相关交易签名（初筛买家）
  getSignaturesForAddress(猎手) → 猎手历史交易签名（频率/ROI/评分）

Helius API
  POST /v0/transactions     → 解析后的交易（nativeTransfers、tokenTransfers）
```

---

## 八、关键配置速查

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `DEX_MIN_24H_GAIN_PCT` | 500 | 24h 涨幅 > 500% |
| `MIN_TOKEN_AGE_SEC` | 3600 | 最少上市 1 小时 |
| `MAX_TOKEN_AGE_SEC` | 43200 | 最多 12 小时 |
| `SM_MIN_DELAY_SEC` | 15 | 开盘 15 秒后买入 |
| `SM_MIN_BUY_SOL` / `SM_MAX_BUY_SOL` | 0.1 / 50 | 单笔买入 0.1～50 SOL |
| `SM_MIN_TOKEN_PROFIT_PCT` | 100 | 该代币至少赚 100% 才能入池 |
| `SM_ENTRY_MIN_PNL_RATIO` | 2 | 入库硬门槛：总盈亏比 ≥ 2 |
| `SM_ENTRY_MIN_WIN_RATE` | 0.2 | 入库硬门槛：胜率 ≥ 20% |
| `SM_ENTRY_MIN_TRADE_COUNT` | 10 | 入库硬门槛：有效代币数 ≥ 10 |
| `SM_ROI_MULT_200` / `SM_ROI_MULT_100_200` / `SM_ROI_MULT_50_100` | 1.0 / 0.9 / 0.75 | 入库：前两档；体检：三档（50~100%×0.75） |
| `SM_LP_CHECK_TX_LIMIT` | 100 | LP 检测专用：主钱包 100 笔优先预检，有任意 LP（加池/撤池）即拉黑 |
| `MAX_FAILURE_RATE_FOR_FREQUENCY` | 0.30 | 签名失败率 ≥30% 即否决（Spam Bot 反向指标，顶尖猎手上链成功率高） |
| `SM_AUDIT_TX_LIMIT` | 300 | 体检拉 300 笔（主钱包模式复用 LP 预检数据） |
| `SM_PROFIT_SCORE_ZERO_PCT` / `SM_PROFIT_SCORE_FULL_PCT` | 20 / 60 | 盈利分：<20% 零分，20%~60% 线性，≥60% 满分 |
| `SM_WIN_RATE_ZERO_PCT` / `SM_WIN_RATE_FULL_PCT` | 15 / 35 | 胜率分阈值 |
| `SM_PNL_RATIO_ZERO` / `SM_PNL_RATIO_FULL` | 1.5 / 3.0 | 盈亏比分阈值 |
| `SM_AUDIT_MIN_PNL_RATIO` | 2 | 体检踢出：盈亏比 < 2 |
| `SM_AUDIT_MIN_WIN_RATE` | 0.2 | 体检踢出：胜率 < 20% |
| `SM_AUDIT_KICK_MAX_ROI_30D_PCT` | 50 | 30 天最大收益 < 50% 直接踢出 |
| `POOL_SIZE_LIMIT` | 100 | 猎手池上限 |
| `ZOMBIE_THRESHOLD_DAYS` | 15 | 15 天未交易视为僵尸 |
| `USDC_PER_SOL` | 100 | 跟单时 USDC 折算 SOL 的固定比例（1 SOL ≈ X USDC），不请求 API |
| **黑名单** | LP 行为 | 仅 LP 行为（加池/撤池）拉黑；低分/亏损不再拉黑 |
| **LP 行为** | ADD/REMOVE LIQUIDITY | 初筛阶段即排除本代币 LP 参与者；`get_hunter_profit_on_token` 入口主钱包 100 笔预检，有任意 LP 即**拉黑**，永不跟仓 |
| `TRADING_BASE_USDC` | True | 交易本币为 USDC，买卖统一用 USDC |
| `SOL_MIN_BALANCE` | 0.2 | 钱包 SOL 低于此值则补充 |
| `SOL_TOPUP_AMOUNT` | 0.5 | 补充时买入的 SOL 数量 |

## 九、跟单分档（按评分）

| 分数区间 | 单次跟仓 | 加仓 | 最大跟仓 | 次数 |
|----------|----------|------|----------|------|
| < 60 | 0.03 SOL | 0.03 SOL | 0.09 SOL | 3 |
| 60～80 | 0.05 SOL | 0.05 SOL | 0.2 SOL | 4 |
| 80～90 | 0.1 SOL | 0.1 SOL | 0.5 SOL | 5 |
| ≥ 90 | 0.2 SOL | 0.2 SOL | 1.0 SOL | 5 |

**规则**：每个代币只跟最早买入的那个钱包地址，其余买入该代币的钱包不跟。

## 十、体检规则

| 步骤 | 操作 |
|------|------|
| 1 | 每 10 天检查一次，对超过 20 天未体检的猎手重新审计 |
| 2 | 按最近 500 笔交易计算：盈亏比、胜率、总盈利、max_roi_30d |
| 3 | 评分加权：用最近 30 天最大收益率 max_roi_30d 乘数（≥200%×1，100%~200%×0.9，50~100%×0.75） |
| 4 | 踢出条件：盈亏比<2 或 胜率<20% 或 总盈利≤0 |
| 5 | 踢出条件：单token最大收益 max_roi_30d < TIER_THREE_ROI（50%）直接踢出；入库也需 ≥ 此值 |
