# 猎手挖掘完整流程：从热门代币到猎手入库

## 一、触发与入口

- **入口**：`HunterMonitorController.discovery_loop()` 定时循环（默认每 15 分钟）
- **调用**：`sm_searcher.run_pipeline(dex_scanner)` → 返回符合条件的猎手列表
- **入库**：`storage.prune_and_update(new_hunters)` → 写入 `data/hunters.json`

---

## 二、阶段 1：获取热门代币（DexScreener）

### 2.1 拉取代币列表

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `GET https://api.dexscreener.com/token-profiles/latest/v1` | DexScreener |
| 2 | 得到「最近有社交信息更新」的代币列表 | |
| 3 | 只保留 `chainId == "solana"` 的代币 | |

### 2.2 逐一代币二次过滤

对每个代币执行：

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `GET https://api.dexscreener.com/latest/dex/tokens/{代币地址}` | DexScreener |
| 2 | 取 `pairs` 中流动性最大的 pair 作为 `main_pair` | |
| 3 | 读取：`liquidity.usd`、`volume.h1`、`pricePercentChange24h`（或 `priceChange.h24`） | |

### 2.3 过滤条件（全部满足才通过）

| 条件 | 配置 | 说明 |
|------|------|------|
| 流动性 ≥ | `DEX_MIN_LIQUIDITY_USD` (10000) | 池子至少 1 万 USD |
| 1h 成交量 ≥ | `DEX_MIN_VOL_1H_USD` (50000) | 1 小时成交至少 5 万 USD |
| 24h 涨幅 | 流动性筛选阶段不再过滤 | 由 sm_searcher 结合年龄判断：年龄在范围内且涨幅达标才挖；涨幅未达标不写 scanned，下次重试 |

### 2.4 输出

通过筛选的代币列表 `hot_tokens`，每个包含：`address`、`symbol`、`liquidity`、`vol_1h`、`gain_24h_pct`。

---

## 三、阶段 2：对每个热门代币挖掘猎手

对 `hot_tokens` 中的每个代币（跳过 `scanned_tokens` 中的）执行 `search_alpha_hunters(token_address)`。

### 3.1 代币年龄检查（DexScreener）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `GET https://api.dexscreener.com/latest/dex/tokens/{代币地址}` | DexScreener |
| 2 | 取所有 pair 的 `pairCreatedAt` 最小值 → `start_time` | |
| 3 | `age = now - start_time` | |

| 条件 | 配置 | 不满足时 |
|------|------|----------|
| `age < MIN` | `MIN_TOKEN_AGE_SEC` | 跳过，不写入 `scanned_tokens` |
| `age > MAX` | `MAX_TOKEN_AGE_SEC` | 跳过，写入 `scanned_tokens`（超龄不再考虑） |
| `age` 在范围内但 `涨幅 < DEX_MIN_24H_GAIN_PCT` | - | 跳过，**不**写入 `scanned_tokens`（可能尚未涨起来，下次发现周期重试） |
| `age` 在范围内且涨幅达标 | - | 执行猎手挖掘，完成后写入 `scanned_tokens` |

### 3.2 回溯代币早期交易（Helius RPC）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `getSignaturesForAddress(代币地址, limit=1000)` | Helius RPC |
| 2 | 时间窗口：`[start_time, start_time + SM_MAX_DELAY_SEC]`（约 3 小时） | |
| 3 | 若本页最老交易 `> 窗口结束`，用 `before=最后一条 signature` 继续翻页 | |
| 4 | 最多翻 `MAX_BACKTRACK_PAGES` (30) 页 | |
| 5 | 收集窗口内所有交易签名 → `found_early_txs` | |
| 6 | 按时间排序，取前 `SM_EARLY_TX_PARSE_LIMIT` (300) 笔 → `target_txs` | |

### 3.3 解析早期交易（Helius API）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `POST https://api.helius.xyz/v0/transactions`，每批最多 90 笔 | Helius |
| 2 | 得到 `nativeTransfers`、`tokenTransfers` 等解析后的交易 | |

### 3.4 初筛买家

对每笔交易：

| 步骤 | 操作 |
|------|------|
| 1 | `delay = blockTime - start_time`，`delay < 15` 秒则跳过 |
| 2 | 合并 `nativeTransfers` + `tokenTransfers`(WSOL 转出) + USDC 转出（按 DexScreener 现价折算 SOL），统计每个 `fromUserAccount` 的 SOL 等价支出 |
| 3 | 取支出最多的地址为买家，`spend_sol = 支出 SOL` |
| 4 | 若 `0.1 ≤ spend_sol ≤ 50` 且该地址未出现过 → 加入 `hunters_candidates` |
| 5 | 每个地址只计第一次出现（`seen_buyers` 去重） |

输出：`hunters_candidates`，每项含 `address`、`entry_delay`、`cost`。

---

## 四、阶段 3：收益过滤 + 频率检测 + 评分（生产者-消费者）

对 `hunters_candidates` 中每个地址依次处理，一次拉取、多步复用。

### 4.1 频率检测（只拉前 120 笔）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | `getSignaturesForAddress(猎手地址, limit=500)` | Helius RPC |
| 2 | `fetch_parsed_transactions(sigs[:120])` | Helius API（约 2 次请求） |
| 3 | `_is_frequent_trader_by_real_txs(txs, address)`：最近 100 笔真实交易平均间隔 < 5 分钟 → 视为频繁 | |
| 4 | 若频繁 → 直接 `return (None, None)`，不再拉后续 380 笔 | 节省约 4 次 API |

### 4.2 拉满 500 笔并计算 ROI（软门槛）

| 步骤 | 操作 | 数据源 |
|------|------|--------|
| 1 | 若不频繁 → `fetch_parsed_transactions(sigs[120:500])` | Helius API |
| 2 | 合并为 500 笔交易 `txs` | |
| 3 | 遍历交易，只关注该代币：汇总 `buy_sol`、`sell_sol`、`tokens_held` | |
| 4 | 未清仓时：`_get_token_price_sol(代币)` 取现价，`总价值 = sell_sol + tokens_held × 现价` | DexScreener |
| 5 | `ROI = (总价值 - buy_sol) / buy_sol × 100` | |
| 6 | 入库门槛：≥100% 进评分池；<100% 或 `buy_sol < 0.01` → 直接淘汰 | |

**ROI 评分乘数**：
- **入库时**：用该代币入库时的 ROI → ≥200%×1，100%~200%×0.9
- **体检时**：用最近 30 天最大收益率 → ≥200%×1，100%~200%×0.9，50~100%×0.75（<50% 直接踢出）

### 4.3 体检评分（复用 4.2 的 txs）

| 步骤 | 操作 |
|------|------|
| 1 | `analyze_hunter_performance(..., pre_fetched_txs=txs)`，不再请求 Helius |
| 2 | 排除当前代币，按其他代币汇总买入/卖出 |
| 3 | 只保留买入成本 > 0.05 SOL 的项目，全部用于评分（不限定 15 个） |
| 4 | `win_rate` = 盈利项目数 / 总项目数 |
| 5 | `total_profit` = 总利润 (SOL) |
| 6 | `avg_roi_pct` = 平均盈利率 (%) |
| 7 | `pnl_ratio` = 盈利单利润和 / 亏损单亏损和 |
| 8 | `max_roi_30d` / `max_roi_60d` = 最近 30/60 天内单笔最大 ROI % |

### 4.4 评分公式

```
胜率分 H (30%)：< 15% 零分，15%~35% 线性 0.5~1，≥35% 满分
盈利分 P (40%)：avg_roi_pct < 20% 零分，20%~60% 线性，≥60% 满分
盈亏比分 R (30%)：总盈亏比 < 1.5 零分，1.5~3 线性，> 3 满分
基础分 = H×30 + P×40 + R×30
最终分数 = 基础分 × ROI乘数（见 4.2）
scores_detail 格式：H:x.xx/P:x.xx/R:x.xx
```

### 4.5 入库条件（硬门槛，全部满足）

| 条件 | 配置 |
|------|------|
| 总盈亏比 ≥ 2 | `SM_ENTRY_MIN_PNL_RATIO` |
| 胜率 ≥ 20% | `SM_ENTRY_MIN_WIN_RATE` |
| 有效交易代币数 ≥ 10 | `SM_ENTRY_MIN_TRADE_COUNT` |
| 总盈利 > 0 | - |

满足条件的加入 `verified_hunters`，并写入 `max_roi_30d`（入库当天记为当前代币 ROI）。

### 4.6 标记已扫描

| 步骤 | 操作 |
|------|------|
| 1 | 将代币地址写入 `data/scanned_tokens.json` |
| 2 | 下次挖掘时跳过该代币 |

---

## 五、阶段 4：汇总与过滤

| 步骤 | 操作 |
|------|------|
| 1 | 合并所有代币的 `verified_hunters` → `all_hunters` |
| 2 | 按分数从高到低排序 |
| 3 | 不再按最低分硬过滤，满足入库硬门槛即可进入 |
| 4 | 返回给 `HunterMonitorController` |

---

## 六、阶段 5：猎手入库（HunterStorage）

| 步骤 | 操作 |
|------|------|
| 1 | 清理僵尸：`last_active` 距现在超过 `ZOMBIE_THRESHOLD` (15 天) 的删除 |
| 2 | 对每个新猎手，满足入库四硬门槛即可（盈亏比≥2、胜率≥20%、代币数≥10、总盈利>0） |
| 3 | 若地址已存在 → 更新信息，保留原 `last_audit` |
| 4 | 若库未满 (`len < POOL_SIZE_LIMIT` 100) → 直接入库 |
| 5 | 若库已满 → 与分数最低者 PK，高分替换低分 |
| 6 | 写入 `data/hunters.json`，含 `max_roi_30d` |

---

## 七、数据流与 API 消耗概览

```
DexScreener
  token-profiles/latest     → 代币列表
  /latest/dex/tokens/{addr} → 流动性/成交量/24h涨幅、代币年龄、现价

Helius RPC
  getSignaturesForAddress(代币) → 代币相关交易签名（初筛买家）
  getSignaturesForAddress(猎手) → 猎手历史交易签名（频率/ROI/评分）

Helius API
  POST /v0/transactions     → 解析后的交易（nativeTransfers、tokenTransfers）
```

---

## 八、关键配置速查

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `DEX_MIN_24H_GAIN_PCT` | 1000 | 24h 涨幅 > 1000% |
| `MIN_TOKEN_AGE_SEC` | 3600 | 最少上市 1 小时 |
| `MAX_TOKEN_AGE_SEC` | 43200 | 最多 12 小时 |
| `SM_MIN_DELAY_SEC` | 15 | 开盘 15 秒后买入 |
| `SM_MIN_BUY_SOL` / `SM_MAX_BUY_SOL` | 0.1 / 50 | 单笔买入 0.1～50 SOL |
| `SM_MIN_TOKEN_PROFIT_PCT` | 100 | 该代币至少赚 100% 才能入池 |
| `SM_ENTRY_MIN_PNL_RATIO` | 2 | 入库硬门槛：总盈亏比 ≥ 2 |
| `SM_ENTRY_MIN_WIN_RATE` | 0.2 | 入库硬门槛：胜率 ≥ 20% |
| `SM_ENTRY_MIN_TRADE_COUNT` | 10 | 入库硬门槛：有效代币数 ≥ 10 |
| `SM_ROI_MULT_200` / `SM_ROI_MULT_100_200` / `SM_ROI_MULT_50_100` | 1.0 / 0.9 / 0.75 | 入库：前两档；体检：三档（50~100%×0.75） |
| `SM_FREQUENCY_CHECK_TX_LIMIT` | 120 | 频率检测先拉 120 笔 |
| `SM_AUDIT_TX_LIMIT` | 500 | 体检拉 500 笔 |
| `SM_PROFIT_SCORE_ZERO_PCT` / `SM_PROFIT_SCORE_FULL_PCT` | 20 / 60 | 盈利分：<20% 零分，20%~60% 线性，≥60% 满分 |
| `SM_WIN_RATE_ZERO_PCT` / `SM_WIN_RATE_FULL_PCT` | 15 / 35 | 胜率分阈值 |
| `SM_PNL_RATIO_ZERO` / `SM_PNL_RATIO_FULL` | 1.5 / 3.0 | 盈亏比分阈值 |
| `SM_AUDIT_MIN_PNL_RATIO` | 2 | 体检踢出：盈亏比 < 2 |
| `SM_AUDIT_MIN_WIN_RATE` | 0.2 | 体检踢出：胜率 < 20% |
| `SM_AUDIT_KICK_MAX_ROI_30D_PCT` | 50 | 30 天最大收益 < 50% 直接踢出 |
| `POOL_SIZE_LIMIT` | 100 | 猎手池上限 |
| `ZOMBIE_THRESHOLD_DAYS` | 15 | 15 天未交易视为僵尸 |
| `USDC_PER_SOL` | 100 | 跟单时 USDC 折算 SOL 的固定比例（1 SOL ≈ X USDC），不请求 API |
| `WALLET_BLACKLIST_*` | - | 劣质猎手黑名单：评分<50 或 亏损≥30U 且胜率<40% 则加入，下次直接跳过 |
| `TRADING_BASE_USDC` | True | 交易本币为 USDC，买卖统一用 USDC |
| `SOL_MIN_BALANCE` | 0.2 | 钱包 SOL 低于此值则补充 |
| `SOL_TOPUP_AMOUNT` | 0.5 | 补充时买入的 SOL 数量 |

## 九、跟单分档（按评分）

| 分数区间 | 单次跟仓 | 加仓 | 最大跟仓 | 次数 |
|----------|----------|------|----------|------|
| < 60 | 0.03 SOL | 0.03 SOL | 0.09 SOL | 3 |
| 60～80 | 0.05 SOL | 0.05 SOL | 0.2 SOL | 4 |
| 80～90 | 0.1 SOL | 0.1 SOL | 0.5 SOL | 5 |
| ≥ 90 | 0.2 SOL | 0.2 SOL | 1.0 SOL | 5 |

**规则**：每个代币只跟最早买入的那个钱包地址，其余买入该代币的钱包不跟。

## 十、体检规则

| 步骤 | 操作 |
|------|------|
| 1 | 每 10 天检查一次，对超过 20 天未体检的猎手重新审计 |
| 2 | 按最近 500 笔交易计算：盈亏比、胜率、总盈利、max_roi_30d |
| 3 | 评分加权：用最近 30 天最大收益率 max_roi_30d 乘数（≥200%×1，100%~200%×0.9，50~100%×0.75） |
| 4 | 踢出条件：盈亏比<2 或 胜率<20% 或 总盈利≤0 |
| 5 | 踢出条件：max_roi_30d < 50% 直接踢出（入库需 100%+，可能未结算，结算后若掉到 50% 以下则踢出） |
