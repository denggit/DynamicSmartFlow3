# Helius Credit 日消耗估算（严谨版）

> 每次 `POST /v0/transactions` = **100 credits**，与请求内交易笔数无关。

---

## 一、代码逻辑与计费单位

### 跟单监控消费队列逻辑

```python
# hunter_monitor._consume_sig_queue_loop
for _ in range(SIG_QUEUE_BATCH_SIZE):  # 最多 100 次
    sig = await asyncio.wait_for(self._sig_queue.get(), timeout=SIG_QUEUE_DRAIN_TIMEOUT)  # 0.3s
    ...
resp = await client.post(url, json={"transactions": to_fetch[:100]})  # 1 次 POST = 100 credits
```

- 每次 `get()` 最多等 **0.3 秒**，队列空则 timeout，立刻结束本轮凑批
- WebSocket 每笔交易推送 **1 个 signature**
- 实时场景下，交易通常分散到达，**0.3s 内很少有多笔**
- **结论**：多数情况下 **每笔交易 ≈ 1 次 POST = 100 credits**

### 挖掘与体检逻辑

- 每批最多 100 笔，300 笔 → 3 次 POST = **300 credits**
- ROI 达标者复用 `pre_fetched_txs`，不再多花 Helius

---

## 二、基础假设（与 config 一致）

| 参数 | 值     | 来源 |
|------|-------|------|
| 猎手池上限 | 100   | `POOL_SIZE_LIMIT` |
| 挖掘间隔（池未满） | 30 分钟 | `DISCOVERY_INTERVAL` |
| 挖掘间隔（池满） | 24 小时 | `DISCOVERY_INTERVAL_WHEN_FULL_SEC` |
| 初筛解析笔数 | 300   | `SM_EARLY_TX_PARSE_LIMIT` |
| ROI/体检解析笔数 | 300   | `SM_AUDIT_TX_LIMIT` |
| 体检有效期 | 20 天  | `AUDIT_EXPIRATION_DAYS` |
| 维护周期 | 10 天  | `MAINTENANCE_DAYS` |
| 凑批超时 | 0.3s  | `SIG_QUEUE_DRAIN_TIMEOUT` |

---

## 三、按来源估算

### 1. 跟单监控（实时逐笔）

| 假设 | 说明 |
|------|------|
| 猎手日均交易 | 池内非人人活跃，取 30% 活跃 × 每人 5 笔 ≈ **150 笔/天** |
| 凑批效率 | 实时为主，约 80% 批次为 **1 笔**，20% 为 2～5 笔 |
| 等效 | 约 **120 次 POST**（150 × 0.8 + 30 × 0.2 ≈ 126） |

**日消耗**：**12,000 ~ 15,000 credits**（按 100 credits/次）

若交易更频繁（50% 活跃 × 8 笔 = 400 笔/天）：**~40,000 credits/天**

| 场景 | 日均交易笔数 | 等效 POST 次数 | credits/天 |
|------|--------------|----------------|------------|
| 低活跃 | 80 | ~70 | ~7,000 |
| 中等 | 150 | ~120 | ~12,000 |
| 高活跃 | 400 | ~350 | ~35,000 |

---

### 2. 挖掘（sm_searcher）

#### 2a. 初筛（每个达标代币）

- 300 笔 ÷ 100 = **3 次 POST = 300 credits/代币**

#### 2b. ROI 过滤（每个候选人）

- `get_hunter_profit_on_token`：300 笔 = **300 credits/人**
- ROI 达标者：`analyze_hunter_performance` 复用，0 额外
- 未达标者：每人仍消耗 300 credits

**单代币消耗** = 300 + 候选人数量 × 300

#### 2c. 日挖掘量

| 池状态 | 轮次/天 | 每轮新代币（通过年龄+涨幅） | 每代币候选人 |
|--------|---------|-----------------------------|--------------|
| 池满 | 1 | 0～2（多数已 scanned） | 5～12 |
| 池未满 | 96 (15min) | 0.1～0.5 均值 | 8～15 |

**池满**：约 1 代币 × (300 + 8×300) = **2,700 credits/天**  
**池未满**：约 8 代币 × (300 + 10×300) = **26,400 credits/天**

| 池状态 | 日新代币 | 候选人/代币 | credits/天 |
|--------|----------|-------------|------------|
| 池满 | 1 | 8 | ~2,700 |
| 中等 | 5 | 10 | ~16,500 |
| 池未满 | 8 | 12 | ~31,200 |

---

### 3. 体检（maintenance_loop）

- 每 10 天执行，对超过 20 天未体检的猎手做 `analyze_hunter_performance`
- 每人 300 笔 = **300 credits**
- 均匀假设：100 猎手 ÷ 20 天 ≈ **5 人/天**
- **日分摊**：5 × 300 = **1,500 credits/天**

---

## 四、日总消耗（严肃估算）

| 来源 | 低 | 中 | 高 |
|------|-----|-----|-----|
| 跟单监控 | 7,000 | 12,000 | 35,000 |
| 挖掘 | 2,700 | 16,500 | 31,200 |
| 体检 | 1,500 | 1,500 | 1,500 |
| **合计/天** | **~11,200** | **~30,000** | **~67,700** |

---

## 五、典型场景汇总

| 场景 | 条件 | credits/天 | Free 1M 可用天数 |
|------|------|------------|------------------|
| 池满 + 低活跃 | 挖掘少、猎手交易少 | ~11,000 | ~90 天 |
| 日常运行 | 池 50%、中等挖掘与跟单 | ~30,000 | ~33 天 |
| 新池 + 高活跃 | 多代币挖掘、猎手交易多 | ~68,000 | ~15 天 |

---

## 六、关键结论

1. **跟单是主要消耗**：实时逐笔场景下，每笔交易约 100 credits，占比往往最高  
2. **凑批超时 0.3s 偏短**：多数批次只有 1 笔，可考虑 1～2s 做凑批，在延迟与 credit 间折中  
3. **挖掘与池状态强相关**：池满时挖掘消耗低，池未满时显著上升

---

## 七、可调参数影响

| 配置项 | 当前 | 调大省 credit | 调小省 credit |
|--------|------|---------------|---------------|
| `SIG_QUEUE_DRAIN_TIMEOUT` | 0.3s | ✓ 凑批更多 | - |
| `SM_EARLY_TX_PARSE_LIMIT` | 300 | - | ✓ |
| `SM_AUDIT_TX_LIMIT` | 300 | - | ✓ |
| `DISCOVERY_INTERVAL` | 1800s | ✓ 挖掘更少 | - |
