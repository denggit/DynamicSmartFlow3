
# 📘 DynamicSmartFlow3 (DSF3) 开发文档

**版本**: V6.0 (Golden Window Edition)
**定位**: 工业级 Solana 链上“聪明钱”挖掘与自动化跟单系统
**核心理念**: 宁缺毋滥，精准打击。利用历史数据验证能力，利用实时监控捕捉共振。

---

## 1. 项目概述 (Overview)

DynamicSmartFlow3 是一个全自动化的量化交易系统，专为 Solana 链上的 Meme 代币和早期项目设计。它区别于传统的“冲土狗”机器人，采用了**“猎手溯源 -> 履历审计 -> 实时共振 -> 精细化跟单”**的闭环逻辑。

### 核心优势

* **时光倒流审计 (V6)**：精准回溯代币开盘前 15 分钟的买入行为，找到真正的早期布局者。
* **黄金窗口策略**：只挖掘上市 15 分钟 ~ 3 小时的代币，避开纯空气币（太新）和死盘（太老）。
* **虚拟份额管理**：独创的持仓管理机制，将单币持仓按猎手贡献度切割，实现“谁卖跟谁跑，谁加跟谁买”。
* **真实交易闭环**：集成 Jupiter Aggregator + Helius RPC，支持自动优先费（Auto Priority Fee），保障上链成功率；与 SmartFlow3 对齐 Quote 参数、Swap payload、TxOpts（max_retries）等。

---

## 2. 系统架构 (System Architecture)

系统由四个核心服务并发运行，通过 `main.py` 进行协调：

| 模块名称 | 对应文件 | 角色 | 核心职责 |
| --- | --- | --- | --- |
| **Discovery (发现)** | `dex_scanner.py` | 雷达 | 扫描 DexScreener，过滤出符合年龄要求的热门代币。 |
| **Trace (溯源)** | `sm_searcher.py` | 猎头 | 对热门代币进行深度链上审计，挖掘高分猎手。 |
| **Monitor (监控)** | `hunter_monitor.py` | 哨兵 | 维护猎手库，监听 WebSocket，触发“开仓共振信号”。 |
| **Agent (特工)** | `hunter_agent.py` | 管家 | 开仓后启动，死死盯住持仓猎手的一举一动（加减仓）。 |
| **Trader (交易)** | `trader.py` | 操盘手 | 执行链上 Swap，管理资金池，计算盈亏与份额。 |

---

## 3. 核心模块详解 (Core Modules)

### 3.1. 猎手挖掘 (`sm_searcher.py`)

这是系统的“大脑”，负责筛选谁值得跟。

* **V6 黄金窗口逻辑**:
* 通过 DexScreener API 获取 `pairCreatedAt`。
* **拒绝**: 上市 < 15 分钟 (数据不稳定/风险高)。
* **拒绝**: 上市 > 3 小时 (早期数据被淹没，挖掘成本高)。
* **接受**: 15m < Age < 3h。


* **时光倒流回溯 (Time Machine)**:
* 由于 RPC 是倒序返回交易，系统会自动使用 `before` 参数分页回溯。
* 目标：找到 `blockTime` 接近 `pairCreatedAt` 的那批交易。
* **熔断机制**: 最多回翻 10-15 页，防止 API 耗尽。


* **深度审计与评分**:
* **当前剔除**: 计算猎手胜率时，强制剔除当前正在分析的 Token（防止未结盈利造成的误判）。
* **评分公式**: `30% 胜率 + 40% 入场时机 + 30% 抗跌能力`。
* **去重**: 挖掘过的代币存入 `data/scanned_tokens.json`，永久不再扫描。



### 3.2. 猎手监控 (`hunter_monitor.py`)

这是系统的“眼睛”，负责全天候值守。

* **多线程架构**:
* `discovery_loop`: 每 10 分钟调用一次 `searcher` 补充新猎手。
* `realtime_monitor_loop`: 保持 Helius WebSocket 连接，监听猎手交易。
* `maintenance_loop`: 每天运行一次，清理僵尸地址（>10天无交易），每15天重算一次猎手分数。


* **首买追高限制**：首个猎手买入后若已涨 300%（现价/首买价 ≥ 4），坚决不买、不加仓。
* **首买者清仓禁止**：首个买入该代币的猎手在共振触发前已清仓，则该代币**永久禁止共振**，后续任意数量猎手买入均不再开仓。
* **LP 行为黑名单**：若猎手曾对该代币有任何 LP 操作（加池/撤池等），视为项目方或老鼠仓，先拉 100 笔预检即淘汰，WARNING 日志 + 加入 `wallet_blacklist.json`，共振时跳过、开仓前二次过滤，永不跟仓。
* **猎手分数门槛**：维护时剔除 60 分以下地址，新猎手入库也需 ≥ 60 分，只跟单 60 分以上。
* **共振触发条件 (Signal Trigger)**：取最早买入该 token 的猎手（≥ 60 分）作为跟单对象。
* **前置**：分数最高的前 3 名猎手中，至少一人评分 > 60，否则跳过该代币。
* 同一代币被 2 个猎手持仓，且总分数 ≥ 120。
* 或 1 个高分猎手（≥75 分）持仓。


* **监听与交易解析（与 SmartFlow3 对齐）**:
* **WebSocket**: 使用 Helius Enhanced `transactionSubscribe`，`accountInclude` 一次传入所有猎手地址（最多 5 万），仅收猎手相关交易，省 credit；`commitment: "processed"` 以更早收到通知。
* **订阅确认**: 发送 `transactionSubscribe` 后收到 `result` 即为确认；收到 `transactionNotification` 时取 `signature` 入队，每笔均打日志便于排查。
* **拉取详情**: WebSocket 推送时 Helius 可能尚未索引该交易，因此拉取详情采用**重试 + 退避**（最多 3 次，间隔 2+i 秒），与 [SmartFlow3 monitor](https://github.com/denggit/SmartFlow3) 一致，减少“有推送但拉不到详情”导致的漏单。
* **参与账户**: 从交易的 `feePayer`、`nativeTransfers`、`tokenTransfers`（及若有 `accountData`）的 from/to 收集参与账户，与监控列表求交得到“本单涉及的猎手”，避免依赖可能缺失的 `accountData` 导致无猎手日志。
* **解析兼容**: `TransactionParser` 对 Helius 的 `tokenAmount` 做兼容：支持数字或对象 `{ amount, decimals }`，与 SmartFlow3 的 `parse_tx` 行为一致，避免解析报错或漏算。


### 3.3. 跟单管家 (`hunter_agent.py`)

这是系统的“风控官”，负责持仓后的动态博弈。

* **任务制监控**: 主程序买入后，下达 `start_tracking(token, hunters)` 指令。
* **余额追踪**:
* 使用 Helius RPC 解析交易日志。
* **关键点**: 内部计算全部使用 **Raw Amount (整数)**，避免精度丢失。


* **信号输出**:
* `HUNTER_SELL`: 计算卖出比例 (Ratio)，通知 Trader 跟随，最低每次卖出 30%。
* `HUNTER_BUY`: 仅跟单猎手加仓且 ≥ 1 SOL 时，按档位加仓。**单猎手模式不再添加新猎手**。
* **USDC 折算**：当猎手用 USDC 买卖时，跟单不再请求 DexScreener 获取实时价格，而是用 `USDC_PER_SOL` 固定折算（默认 1 SOL ≈ 100 USDC），在 `config/settings.py` 中可配置。

* **基线前交易过滤**：Monitor 消费队列可能延迟，导致「共振触发那笔买入」在 `start_tracking` 之后才被推给 Agent。若用 `time.time()` 误当作 tx 时间，会把基线前的买入当作「加仓」发出 HUNTER_BUY，进而 sync_positions 发现余额对不上会误判「减仓」。**修复**：`on_tx_from_monitor` 使用 tx 的 `blockTime`/`timestamp` 作为真实时间；`analyze_action` 在 `tx_time < mission.start_time` 时直接跳过，不更新状态、不发出任何信号。



### 3.4. 核心交易 (`trader.py`)

这是系统的“手”，负责资金与执行。

* **真实交易实现**:
* 使用 `solders` 进行本地签名。
* 使用 `Jupiter v1 API` 获取最优路由。
* **Priority Fee**: 设置为 `"auto"`，由 Jupiter 自动计算上链所需的最小优先费（非 Jito 贿赂）。


* **单猎手跟单**：同一 token 只跟**最早交易**该 token 的猎手（且 ≥ 60 分），其余猎手不跟，不添加新猎手。


* **操作**: 猎手 A 卖出 50%，我们只卖出 **属于 A 的那份份额** 的 50%。


* **单位统一**:
* 严格处理 `Decimals`。RPC 返回 Raw Amount -> 除以  -> 得到 UI Amount -> 计算均价。
* **均价计算**：开仓均价 = `buy_sol / token_amount_ui`，其中 `token_amount_ui` 必须为本笔 Swap 的到账量。当买入验证超时走链上余额兜底时，返回 Jupiter Quote 的 `outAmount`（本笔到账量），而非钱包总余额 `chain_raw`，否则若钱包已有该代币（前次买入/重试等）会高估 token 数量、低估均价，导致错误触发止盈。



---

## 4. 交易策略与风控配置 (Strategy & Risk)

所有参数均在 `config/settings.py` 中集中管理。

### 4.1. 资金管理（单猎手分档）

| 猎手分数 | 开仓 | 加仓 | 单币上限 | 止损 |
|---------|------|------|----------|------|
| 60-80   | 0.05 SOL | 0.05 SOL (猎手加≥1 SOL才跟) | 0.3 SOL | 30% |
| 80-90   | 0.1 SOL  | 0.1 SOL                    | 0.5 SOL | 40% |
| 90+     | 0.2 SOL  | 0.2 SOL                    | 1.0 SOL | 50% |

### 4.2. 止盈与止损 (Take Profit & Stop Loss)

**止损**：按档位（60-80: 30% / 80-90: 40% / 90+: 50%）。止盈/止损每 10 秒检测一次。

**止盈**：按**单 token 成本价 (average_price)** 计算，分批止盈：

1. 单 token 价值 ≥ 成本价 × 2.5 (收益 150%): 卖出 50% 持仓。
2. 单 token 价值 ≥ 成本价 × 4.0 (收益 300%): 再卖出 50%。
3. 单 token 价值 ≥ 成本价 × 11.0 (收益 1000%): 再卖出 50%。

*示例*：买入 0.1 SOL 得 100 token → 成本 0.001 SOL/token。加仓 0.1 SOL 得 50 token → 新成本 (0.2/150)≈0.00133 SOL/token，第一次止盈触发价为 0.00133×2.5≈0.00333 SOL/token。**一旦任意止盈触发，禁止再加仓**（猎手加仓或新增猎手均不跟）。

### 4.3. 止损/跟随策略

* **跟随卖出**: 当猎手卖出比例 `X` 时，我们也卖出对应份额的 `max(X, 30%)`（见下方配置）。
* **最低动作**: 猎手卖出比例 **< 5%** 时不跟（微调忽略）；**≥ 5%** 时跟，且我方至少卖出该猎手对应份额的 **30%**（`MIN_SELL_RATIO`）。例如猎手卖 10%，我们卖该份额的 30%。
* **粉尘清仓**: 若某份额卖出后剩余价值 < `MIN_SHARE_VALUE_SOL`（默认 0.01），直接清空该份额；止盈时若剩余价值不足也直接全仓。
* **链上余额为准**：所有卖出均先查链上余额，查到多少卖多少；查余额失败时兜底 99.9%（`SELL_BUFFER`）防超卖。
* **卖出重试**：失败后重试前会检查链上余额，避免前次交易已成功但验证超时导致的 6024 超卖错误。
* **链上归零同步**：链上持仓为 0 时（卖出失败但实际已成交、手动清仓、或初始化时已清空），同步 `trader_state.json` 并停止监控（`stop_tracking`）。同步时补录 `trading_history`（note：链上对账补录-手动清仓）。
* **链上对账**：每 24 小时（`RECONCILE_INTERVAL_SEC`）拉取钱包最近 100 笔交易，检测手动清仓并同步 `trader_state.json`、补录 `trading_history.json`。环境变量 `RECONCILE_INTERVAL_SEC`、`RECONCILE_TX_LIMIT` 可配置。
* **交易确认**：买入、卖出均需链上确认。广播后轮询 get_signature_statuses，只有确认成功才更新状态，并打「✅ 买入已确认 / ✅ 卖出已确认」日志。
* **二次验证**：初次验证超时/无响应时（RPC 限流易误判），等待 TX_VERIFY_RETRY_DELAY_SEC 后切换 Helius Key 再验一次，避免交易已成功但被误判失败导致漏记持仓、不跟仓卖出。
* **Helius 429 轮询换 Key**：交易验证、获取余额、get_decimals 等所有 Helius RPC 调用遇 429 时，在 Key 池内轮询切换下一 Key 重试（需配置多个：`HELIUS_API_KEY=key1,key2,key3`）。
* **卖出失败日志**：跟随/止损/止盈卖出失败时打 warning；price=0（归零）时也会触发止盈止损检查。
* **止盈 PnL 校正**：DexScreener 价格按 base/quote 正确解析「1 token = ? SOL」；当 DexScreener 显示 >200% 盈利时，用 Jupiter Quote 校验真实可卖价，避免虚假 8317% 等误触发。
* **跟卖余额二次校验**：卖出前再拉一次链上余额并 cap，应对连续多笔跟卖时的链上延迟。
* **关闭前校验**：调用 `stop_tracking` 前先执行 `ensure_fully_closed`，若链上仍有持仓则清仓后再关监控，避免遗漏。
* **实现**: 配置项 `FOLLOW_SELL_THRESHOLD=0.05`、`MIN_SELL_RATIO=0.3`；全平仓（跟随卖出或止盈清仓）后会自动调用 Agent 的 `stop_tracking` 停止该币监控。

### 4.4. 流动性结构风险（买入后兜底）

* **触发**：每 60 分钟调用 DexScreener 查询持仓代币流动性。
* **条件 1**：`current_liquidity_usd < 100`（REMOVE LIQUIDITY 等价，流动性崩塌）→ 立即清仓。
* **条件 2**：`current_liquidity_usd < entry_liquidity_usd × 0.7`（LP 净减少 30%）→ 立即清仓。
* **目的**：兜底买前风险放任；池子撤池或大幅抽资时及时止损。
* **配置**：`config/trading.py` 中 `LIQUIDITY_STRUCTURAL_CHECK_INTERVAL_SEC`、`LIQUIDITY_COLLAPSE_THRESHOLD_USD=100`、`LIQUIDITY_DROP_RATIO=0.7`。`LIQUIDITY_CHECK_DEXSCREENER_INTERVAL_SEC=1.2` 为每次 DexScreener 请求间隔（≥1 秒），持仓多时避免管控。
* **入场流动性**：开仓时调用 `risk_control.check_token_liquidity` 并存入 `Position.entry_liquidity_usd`；重启恢复的旧持仓若无该字段，条件 2 不生效（条件 1 仍生效）。

---

## 5. 环境与部署 (Environment)

### 5.1. 依赖库

```text
python >= 3.10
solders
solana
httpx
websockets
python-dotenv
aiohttp

```

### 5.2. 配置文件 (`.env`)

必须包含以下内容，严禁上传至 GitHub：

```env
# Helius API Key（解析交易、猎手监控）；可填多个逗号分隔，限流时自动换下一个
HELIUS_API_KEY=your-helius-uuid-here
# 多 Key: HELIUS_API_KEY=key1,key2,key3

# Alchemy API Key（签名、RPC、广播）；必填；可填多个，限流时自动换下一个
ALCHEMY_API_KEY=your-alchemy-key-here
# 若免费版易 429，可加大请求间隔（秒）: ALCHEMY_MIN_INTERVAL_SEC=1.5，默认已 1.2s

# Jupiter API Key（可选）；可填多个逗号分隔，仅 Jupiter 限流时自动换下一个，与 Helius 独立
# JUP_API_KEY=your-jup-key
# 多 Key: JUP_API_KEY=key1,key2,key3

# 你的 Solana 钱包私钥 (Base58 字符串)
SOLANA_PRIVATE_KEY=your-private-key-string

# 邮件通知（可选，不配置则不发邮件）
EMAIL_SENDER=your-qq@qq.com
EMAIL_PASSWORD=授权码
EMAIL_RECEIVER=receiver@example.com
SMTP_SERVER=smtp.qq.com
SMTP_PORT=465
BOT_NAME=DSF3

# 日报发送时刻：DAILY_REPORT_TIME 优先（支持 "8" 或 "08:00"），否则用 DAILY_REPORT_HOUR (0-23)
DAILY_REPORT_TIME=8
# 或 DAILY_REPORT_HOUR=8
```

### 5.3. 运行方式

```bash
# 1. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Mac/Linux
# venv\Scripts\activate   # Windows

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动主程序
python main.py

```

---

## 6. 常见问题排查 (Troubleshooting)

### Q1: `trader.py` 报错 "Division by zero"

* **原因**: 获取代币 Decimals 失败，或者买入后 Token 数量为 0。
* **解决**: 代码已增加 `decimals = 6` 的默认兜底；并增加了 `if token_amount_ui > 0` 的检查。

### Q1b: 风控检测包含哪些项？

* **当前检测**（`risk_control.check_is_safe_token`，返回 `(can_buy, halve_position)`）：(1) RugCheck 风险分 >2000 时**减半仓且禁止加仓**（不直接拒绝）；(2) 无 danger 级风险、非蜜罐/不可卖；(3) 铸币权/冻结权必须 Renounced；(4) 买入税 ≤25%；(5) **LP 锁仓 ≥ 70%**（主池流动性未充分锁定则拒跟）；(6) **三无盘拒绝**（无 Twitter/X、无 Telegram 的土狗视为春 PVP 割草盘）；(7) **流动性**：< $1,000 拒绝；$1,000~$3,000 **减半仓且禁止加仓**；≥ $3,000 正常；(8) **FDV ≥ 100 万美金** 时**减半仓且禁止加仓**（不直接拒绝）；(9) **流动性/市值比 ≥ 3%**（防虚胖控盘）；(10) **Top 10 持仓**（防老鼠仓）；(11) **买卖税不可动态修改**：Token2022 的 transferFee.authority 必须为空或系统程序；RugCheck risks 中若提示 transfer fee 可 update/mutable 也拒绝。(12) **非标准 SPL**：RugCheck risks 中若出现 transfer restricted、blacklist、whitelist、transfer hook 等，拒绝（项目方可随时拉黑/限制转出）。
* **说明**：池子过小易崩盘且撤池成本低；庄家控盘过高随时可砸归零。减半仓持仓会设置 `no_addon=True`，后续 HUNTER_BUY 信号不再执行加仓。

### Q1c: 风控检测报 `httpx.ReadTimeout` 或 RugCheck/DexScreener 请求超时？

* **原因**：RugCheck API 或 DexScreener API 响应慢或网络不稳，导致 HTTP 读取超时。
* **解决**：`risk_control.py` 已实现：
  1. **超时延长**：RugCheck 单次 20 秒，DexScreener 15 秒；
  2. **自动重试**：遇 ReadTimeout/ConnectTimeout 时最多重试 3 次，间隔 1.5 秒；
  3. **保守策略**：重试仍失败时返回 `False`（不放行），避免误放行风险代币。

### Q2: 挖掘日志显示 "RPC getSignatures failed"

* **原因**: 触发了 Helius 免费版/标准版的限流（Rate Limit）。
* **解决**: `sm_searcher.py` 中已增加了 `Retry (重试 3 次)` 和 `Exponential Backoff (指数退避)` 机制。

### Q2b: Trader 交易时出现 429 Too Many Requests

* **原因**: Helius RPC 或 Jupiter API 触发限流。
* **解决**: `trader.py` 已实现：(1) `_get_decimals` 遇 429 时切换 Helius Key 并返回默认 6；(2) `_jupiter_swap` 遇 429 时 backoff 后切换 Key 重试。**重要**：若只配置 1 个 Helius Key，切换无效，429 会反复出现；必须在 `.env` 中配置多个：`HELIUS_API_KEY=key1,key2,key3`。

### Q3: 为什么有些猎手利润很高但评分只有 30 分？

* **原因**: 触发了“暴击豁免”。该猎手胜率可能极低（经常归零），但只要总账是赚大钱的（`Total Profit >= 2.0 SOL`），系统就会收录。这属于高风险高回报的“赌徒型猎手”。

### Q4: 交易一直发不出去？

* **原因**: 链上拥堵。
* **解决**: 检查 `settings.py` 中的 `PRIORITY_FEE_SETTINGS` 是否为 `"auto"`。Jupiter 会自动计算所需的优先费。

---

## 7. 未来迭代方向 (Roadmap)

1. **数据库集成**: 目前使用 JSON 文件存储，未来可迁移至 SQLite/PostgreSQL 以支持数千名猎手的分析。
2. **多钱包并发**: 支持多个私钥分仓操作，降低单点风险。
3. **防夹子 (Anti-MEV)**: 接入 Jito Bundle 模式（目前使用 Auto Priority Fee），进一步防止被三明治攻击。
4. **UI 仪表盘**: 开发一个简单的 Web 前端，实时显示当前持仓 PnL 和猎手动态。
