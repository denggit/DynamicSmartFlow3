
# 📘 DynamicSmartFlow3 (DSF3) 开发文档

**版本**: V6.0 (Golden Window Edition)
**定位**: 工业级 Solana 链上“聪明钱”挖掘与自动化跟单系统
**核心理念**: 宁缺毋滥，精准打击。利用历史数据验证能力，利用实时监控捕捉共振。

---

## 1. 项目概述 (Overview)

DynamicSmartFlow3 是一个全自动化的量化交易系统，专为 Solana 链上的 Meme 代币和早期项目设计。它区别于传统的“冲土狗”机器人，采用了**“猎手溯源 -> 履历审计 -> 实时共振 -> 精细化跟单”**的闭环逻辑。

### 核心优势

* **时光倒流审计 (V6)**：精准回溯代币开盘前 15 分钟的买入行为，找到真正的早期布局者。
* **黄金窗口策略**：只挖掘上市 15 分钟 ~ 3 小时的代币，避开纯空气币（太新）和死盘（太老）。
* **虚拟份额管理**：独创的持仓管理机制，将单币持仓按猎手贡献度切割，实现“谁卖跟谁跑，谁加跟谁买”。
* **真实交易闭环**：集成 Jupiter Aggregator + Helius RPC，支持自动优先费（Auto Priority Fee），保障上链成功率；与 SmartFlow3 对齐 Quote 参数、Swap payload、TxOpts（max_retries）等。

---

## 2. 系统架构 (System Architecture)

系统由四个核心服务并发运行，通过 `main.py` 进行协调：

| 模块名称 | 对应文件 | 角色 | 核心职责 |
| --- | --- | --- | --- |
| **Discovery (发现)** | `dex_scanner.py` | 雷达 | 扫描 DexScreener，过滤出符合年龄要求的热门代币。 |
| **Trace (溯源)** | `sm_searcher.py` | 猎头 | 对热门代币进行深度链上审计，挖掘高分猎手。 |
| **Monitor (监控)** | `hunter_monitor.py` | 哨兵 | 维护猎手库，监听 WebSocket，触发“开仓共振信号”。 |
| **Agent (特工)** | `hunter_agent.py` | 管家 | 开仓后启动，死死盯住持仓猎手的一举一动（加减仓）。 |
| **Trader (交易)** | `trader.py` | 操盘手 | 执行链上 Swap，管理资金池，计算盈亏与份额。 |

---

## 3. 核心模块详解 (Core Modules)

### 3.1. 猎手挖掘 (`sm_searcher.py`)

这是系统的“大脑”，负责筛选谁值得跟。

* **V6 黄金窗口逻辑**:
* 通过 DexScreener API 获取 `pairCreatedAt`。
* **拒绝**: 上市 < 15 分钟 (数据不稳定/风险高)。
* **拒绝**: 上市 > 3 小时 (早期数据被淹没，挖掘成本高)。
* **接受**: 15m < Age < 3h。


* **时光倒流回溯 (Time Machine)**:
* 由于 RPC 是倒序返回交易，系统会自动使用 `before` 参数分页回溯。
* 目标：找到 `blockTime` 接近 `pairCreatedAt` 的那批交易。
* **熔断机制**: 最多回翻 10-15 页，防止 API 耗尽。


* **深度审计与评分**:
* **当前剔除**: 计算猎手胜率时，强制剔除当前正在分析的 Token（防止未结盈利造成的误判）。
* **评分公式**: `30% 胜率 + 40% 入场时机 + 30% 抗跌能力`。
* **去重**: 挖掘过的代币存入 `data/scanned_tokens.json`，永久不再扫描。



### 3.2. 猎手监控 (`hunter_monitor.py`)

这是系统的“眼睛”，负责全天候值守。

* **多线程架构**:
* `discovery_loop`: 每 10 分钟调用一次 `searcher` 补充新猎手。
* `realtime_monitor_loop`: 保持 Helius WebSocket 连接，监听猎手交易。
* `maintenance_loop`: 每天运行一次，清理僵尸地址（>10天无交易），每15天重算一次猎手分数。


* **共振触发条件 (Signal Trigger)**:
* 同一代币被 2 个猎手持仓，且总分数 ≥ 100。
* 或 1 个高分猎手（≥80 分）持仓。


* **监听与交易解析（与 SmartFlow3 对齐）**:
* **WebSocket**: 使用 Helius Enhanced `transactionSubscribe`，`accountInclude` 一次传入所有猎手地址（最多 5 万），仅收猎手相关交易，省 credit；`commitment: "processed"` 以更早收到通知。
* **订阅确认**: 发送 `transactionSubscribe` 后收到 `result` 即为确认；收到 `transactionNotification` 时取 `signature` 入队，每笔均打日志便于排查。
* **拉取详情**: WebSocket 推送时 Helius 可能尚未索引该交易，因此拉取详情采用**重试 + 退避**（最多 3 次，间隔 2+i 秒），与 [SmartFlow3 monitor](https://github.com/denggit/SmartFlow3) 一致，减少“有推送但拉不到详情”导致的漏单。
* **参与账户**: 从交易的 `feePayer`、`nativeTransfers`、`tokenTransfers`（及若有 `accountData`）的 from/to 收集参与账户，与监控列表求交得到“本单涉及的猎手”，避免依赖可能缺失的 `accountData` 导致无猎手日志。
* **解析兼容**: `TransactionParser` 对 Helius 的 `tokenAmount` 做兼容：支持数字或对象 `{ amount, decimals }`，与 SmartFlow3 的 `parse_tx` 行为一致，避免解析报错或漏算。


### 3.3. 跟单管家 (`hunter_agent.py`)

这是系统的“风控官”，负责持仓后的动态博弈。

* **任务制监控**: 主程序买入后，下达 `start_tracking(token, hunters)` 指令。
* **余额追踪**:
* 使用 Helius RPC 解析交易日志。
* **关键点**: 内部计算全部使用 **Raw Amount (整数)**，避免精度丢失。


* **信号输出**:
* `HUNTER_SELL`: 计算卖出比例 (Ratio)，通知 Trader 跟随。
* `HUNTER_BUY`: 猎手加仓或新增猎手买入 ≥ 0.1 SOL 时，通知 Trader 加仓 0.1 SOL（单币上限 0.5 SOL）。
* **新增猎手**: 池内猎手首次买入我们正在持有的 token 时，自动加入监控并触发 HUNTER_BUY，我方跟仓 0.1 SOL。1 分钟内多名新猎手加入时只跟仓一次。



### 3.4. 核心交易 (`trader.py`)

这是系统的“手”，负责资金与执行。

* **真实交易实现**:
* 使用 `solders` 进行本地签名。
* 使用 `Jupiter v1 API` 获取最优路由。
* **Priority Fee**: 设置为 `"auto"`，由 Jupiter 自动计算上链所需的最小优先费（非 Jito 贿赂）。


* **虚拟份额系统 (Virtual Shares)**:
* **问题**: 猎手 A 和 B 都买了 Token X，现在 A 跑了，B 还在，我该卖多少？
* **解决**: 系统将持仓划分为虚拟份额，谁卖跟谁跑。
* **1 人时**: 全部份额归其一人，只跟该猎手买卖；若有新猎手进场则触发重新分配。
* **2 人时**: 按分数权重分配（90分 vs 60分 -> 60%:40%）。
* **3 人及以上**: 等权分配（取前三人，1/3 Each）。


* **操作**: 猎手 A 卖出 50%，我们只卖出 **属于 A 的那份份额** 的 50%。


* **单位统一**:
* 严格处理 `Decimals`。RPC 返回 Raw Amount -> 除以  -> 得到 UI Amount -> 计算均价。



---

## 4. 交易策略与风控配置 (Strategy & Risk)

所有参数均在 `config/settings.py` 中集中管理。

### 4.1. 资金管理

* **单币上限**: `0.5 SOL` (绝不重仓梭哈)。
* **起步仓位**: `Total Score * 0.001` (例如 160分 = 0.16 SOL)。
* **加仓步长**: 固定 `0.1 SOL`。
* **最低买入**: `0.1 SOL`。
* **跟仓加仓**: 猎手加仓或新增猎手买入 ≥ `0.1 SOL` 即跟仓 0.1 SOL，单币总持仓不超过 0.5 SOL（`HUNTER_ADD_THRESHOLD_SOL=0.1`）。

### 4.2. 止盈与止损 (Take Profit & Stop Loss)

**止损**：亏损 ≥ 50% 时全仓清仓（`STOP_LOSS_PCT=0.5`）。

**止盈**：按**单 token 成本价 (average_price)** 计算，分批止盈：

1. 单 token 价值 ≥ 成本价 × 2.5 (收益 150%): 卖出 50% 持仓。
2. 单 token 价值 ≥ 成本价 × 4.0 (收益 300%): 再卖出 50%。
3. 单 token 价值 ≥ 成本价 × 11.0 (收益 1000%): 再卖出 50%。

*示例*：买入 0.1 SOL 得 100 token → 成本 0.001 SOL/token。加仓 0.1 SOL 得 50 token → 新成本 (0.2/150)≈0.00133 SOL/token，第一次止盈触发价为 0.00133×2.5≈0.00333 SOL/token。**一旦任意止盈触发，禁止再加仓**（猎手加仓或新增猎手均不跟）。

### 4.3. 止损/跟随策略

* **跟随卖出**: 当猎手卖出比例 `X` 时，我们也卖出对应份额的 `max(X, 30%)`（见下方配置）。
* **最低动作**: 猎手卖出比例 **< 5%** 时不跟（微调忽略）；**≥ 5%** 时跟，且我方至少卖出该猎手对应份额的 **30%**（`MIN_SELL_RATIO`）。例如猎手卖 10%，我们卖该份额的 30%。
* **粉尘清仓**: 若某份额卖出后剩余价值 < `0.05 SOL`，直接清空该份额。
* **链上余额为准**：所有卖出均先查链上余额，查到多少卖多少；查余额失败时兜底 99.9%（`SELL_BUFFER`）防超卖。
* **交易确认**：广播后轮询 get_signature_statuses，只有链上确认成功才更新状态，避免「广播成功但链上执行失败」时误扣持仓。
* **卖出失败日志**：跟随/止损/止盈卖出失败时打 warning；price=0（归零）时也会触发止盈止损检查。
* **止盈 PnL 校正**：DexScreener 价格按 base/quote 正确解析「1 token = ? SOL」；当 DexScreener 显示 >200% 盈利时，用 Jupiter Quote 校验真实可卖价，避免虚假 8317% 等误触发。
* **跟卖余额二次校验**：卖出前再拉一次链上余额并 cap，应对连续多笔跟卖时的链上延迟。
* **关闭前校验**：调用 `stop_tracking` 前先执行 `ensure_fully_closed`，若链上仍有持仓则清仓后再关监控，避免遗漏。
* **实现**: 配置项 `FOLLOW_SELL_THRESHOLD=0.05`、`MIN_SELL_RATIO=0.3`；全平仓（跟随卖出或止盈清仓）后会自动调用 Agent 的 `stop_tracking` 停止该币监控。

---

## 5. 环境与部署 (Environment)

### 5.1. 依赖库

```text
python >= 3.10
solders
solana
httpx
websockets
python-dotenv
aiohttp

```

### 5.2. 配置文件 (`.env`)

必须包含以下内容，严禁上传至 GitHub：

```env
# Helius API Key（RPC/WebSocket）；可填多个逗号分隔，仅 Helius 限流时自动换下一个
HELIUS_API_KEY=your-helius-uuid-here
# 多 Key: HELIUS_API_KEY=key1,key2,key3

# Jupiter API Key（可选）；可填多个逗号分隔，仅 Jupiter 限流时自动换下一个，与 Helius 独立
# JUP_API_KEY=your-jup-key
# 多 Key: JUP_API_KEY=key1,key2,key3

# 你的 Solana 钱包私钥 (Base58 字符串)
SOLANA_PRIVATE_KEY=your-private-key-string

# 邮件通知（可选，不配置则不发邮件）
EMAIL_SENDER=your-qq@qq.com
EMAIL_PASSWORD=授权码
EMAIL_RECEIVER=receiver@example.com
SMTP_SERVER=smtp.qq.com
SMTP_PORT=465
BOT_NAME=DSF3

# 日报发送时刻 (0-23)
DAILY_REPORT_HOUR=8
```

### 5.3. 运行方式

```bash
# 1. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Mac/Linux
# venv\Scripts\activate   # Windows

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动主程序
python main.py

```

---

## 6. 常见问题排查 (Troubleshooting)

### Q1: `trader.py` 报错 "Division by zero"

* **原因**: 获取代币 Decimals 失败，或者买入后 Token 数量为 0。
* **解决**: 代码已增加 `decimals = 6` 的默认兜底；并增加了 `if token_amount_ui > 0` 的检查。

### Q1b: 风控检测包含哪些项？

* **当前检测**（`risk_control.check_is_safe_token`）：(1) RugCheck 风险分 ≤2000；(2) 无 danger 级风险、非蜜罐/不可卖；(3) 铸币权/冻结权必须 Renounced；(4) 买入税 ≤25%；(5) **池子流动性 ≥ $5,000**（防撤池）；(6) **Top 10 持仓**（防老鼠仓）：排除 LP 后，第 2~10 名合计 ≤ 剩余 40%，且单一地址 ≤ 剩余 10%。
* **说明**：池子过小易崩盘且撤池成本低；庄家控盘过高随时可砸归零。

### Q2: 挖掘日志显示 "RPC getSignatures failed"

* **原因**: 触发了 Helius 免费版/标准版的限流（Rate Limit）。
* **解决**: `sm_searcher.py` 中已增加了 `Retry (重试 3 次)` 和 `Exponential Backoff (指数退避)` 机制。

### Q2b: Trader 交易时出现 429 Too Many Requests

* **原因**: Helius RPC 或 Jupiter API 触发限流。
* **解决**: `trader.py` 已实现：(1) `_get_decimals` 遇 429 时切换 Helius Key 并返回默认 6；(2) `_jupiter_swap` 遇 429 时 backoff 后切换 Key 重试。**重要**：若只配置 1 个 Helius Key，切换无效，429 会反复出现；必须在 `.env` 中配置多个：`HELIUS_API_KEY=key1,key2,key3`。

### Q3: 为什么有些猎手利润很高但评分只有 30 分？

* **原因**: 触发了“暴击豁免”。该猎手胜率可能极低（经常归零），但只要总账是赚大钱的（`Total Profit >= 2.0 SOL`），系统就会收录。这属于高风险高回报的“赌徒型猎手”。

### Q4: 交易一直发不出去？

* **原因**: 链上拥堵。
* **解决**: 检查 `settings.py` 中的 `PRIORITY_FEE_SETTINGS` 是否为 `"auto"`。Jupiter 会自动计算所需的优先费。

---

## 7. 未来迭代方向 (Roadmap)

1. **数据库集成**: 目前使用 JSON 文件存储，未来可迁移至 SQLite/PostgreSQL 以支持数千名猎手的分析。
2. **多钱包并发**: 支持多个私钥分仓操作，降低单点风险。
3. **防夹子 (Anti-MEV)**: 接入 Jito Bundle 模式（目前使用 Auto Priority Fee），进一步防止被三明治攻击。
4. **UI 仪表盘**: 开发一个简单的 Web 前端，实时显示当前持仓 PnL 和猎手动态。
