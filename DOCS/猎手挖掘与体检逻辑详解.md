# 猎手挖掘与体检逻辑详解

> 从热门代币中发现「Smart Money」猎手，并定期审计其表现的完整流程。含 API 调用、参数细节、数据流。

---

## 一、整体架构与调用链

```
run_pipeline (sm_searcher)
    │
    ├── DexScanner.scan()  [DexScreener x2]
    │     └── 输出: hot_tokens (流动性≥1万、1h成交≥5万)
    │
    └── 对每个 hot_token: search_alpha_hunters(token_address)
            │
            ├── verify_token_age_via_dexscreener  [DexScreener x1]
            ├── 回溯早期交易  [Alchemy RPC 翻页 + Helius 解析]
            ├── 初筛买家 (解析结果)
            └── 对每个 candidate:
                    get_hunter_profit_on_token  [Alchemy x2 + Helius x1 + DexScreener x2]
                    → analyze_hunter_performance [Alchemy x1 + Helius x1 + DexScreener x1]
                    → 入库硬门槛 + 评分

体检 (hunter_monitor)
    ├── run_immediate_audit：启动时全量审计
    │     └── 每个猎手: analyze_hunter_performance
    │
    └── maintenance_loop：每 10 天
          ├── 每个猎手: is_frequent_trader [Alchemy x1]
          └── 超 20 天未体检: analyze_hunter_performance [Alchemy + Helius + DexScreener]
```

---

## 二、API 使用清单（按调用时机）

| 阶段 | API | 用途 | 调用方 |
|------|-----|------|--------|
| 挖掘·阶段0 | DexScreener | 热门代币列表 | DexScanner |
| 挖掘·阶段1 | DexScreener | 代币年龄/涨幅/价格 | sm_searcher |
| 挖掘·阶段2 | Alchemy RPC | 签名列表 getSignaturesForAddress | sm_searcher |
| 挖掘·阶段2 | Helius HTTP | 解析交易 POST /transactions | sm_searcher |
| 挖掘·阶段3 | 本地 | ATA 推导 (solders PDA) | utils/solana_ata |
| 体检 | Alchemy RPC | 签名列表 | sm_searcher / hunter_monitor |
| 体检 | Helius HTTP | 解析交易 | sm_searcher |
| 体检 | DexScreener | USDC 价格 (SOL 折算) | sm_searcher |

---

## 三、阶段 0：DexScanner 获取热门代币

### 3.1 API 1：token-profiles 最新代币

| 项 | 值 |
|----|-----|
| **URL** | `GET https://api.dexscreener.com/token-profiles/latest/v1` |
| **方法** | GET |
| **超时** | 10s |
| **返回** | JSON 数组，每项含 `chainId`、`tokenAddress` 等 |

**二次过滤（逐代币）**：

| 项 | 值 |
|----|-----|
| **URL** | `GET https://api.dexscreener.com/latest/dex/tokens/{token_address}` |
| **超时** | 5s |
| **返回** | `{ pairs: [{ liquidity: {usd}, volume: {h1}, ... }] }` |

**过滤条件**（`dex_scanner.py`）：

- `chainId == "solana"`
- 取主 pair：`max(pairs, key=lambda p: p.liquidity.usd)`
- `liquidity.usd >= DEX_MIN_LIQUIDITY_USD` (10000)
- `volume.h1 >= DEX_MIN_VOL_1H_USD` (50000)

**输出**：`hot_tokens`，每项 `{address, symbol, liquidity, vol_1h, gain_24h_pct}`

---

## 四、阶段 1：代币年龄与涨幅检查

### 4.1 API 2：DexScreener 代币详情（sm_searcher 使用）

| 项 | 值 |
|----|-----|
| **URL** | `GET https://api.dexscreener.com/latest/dex/tokens/{token_address}` |
| **超时** | 5s |
| **代码位置** | `verify_token_age_via_dexscreener` |

**解析逻辑**：

```
pairs = data.pairs
main_pair = max(pairs, key=lambda p: float(p.liquidity.usd or 0))

gain_24h:
  - 优先 pricePercentChange24h（已是百分比）
  - 否则 priceChange.h24；若 1 < gain_24h <= 20 视为倍数：(gain-1)*100

start_time = main_pair.pairCreatedAt / 1000   # 毫秒→秒
age = now - start_time
```

**判定表**：

| 条件 | 配置 | should_save | 动作 |
|------|------|-------------|------|
| `age < 1800` (30分钟) | MIN_TOKEN_AGE_SEC | false | 跳过，不写 scanned |
| `age > 21600` (6小时) | MAX_TOKEN_AGE_SEC | **true** | 跳过，写 scanned |
| `gain_24h < 500` | DEX_MIN_24H_GAIN_PCT | false | 跳过，不写 scanned |
| 年龄在范围内且 gain≥500 | - | false | 执行挖掘 |

---

## 五、阶段 2：回溯早期交易与初筛买家

### 5.1 API 3：Alchemy getSignaturesForAddress

| 项 | 值 |
|----|-----|
| **端点** | `POST https://solana-mainnet.g.alchemy.com/v2/{api-key}` |
| **方法** | JSON-RPC |
| **RPC 方法** | `getSignaturesForAddress` |
| **参数** | `[address, { limit: 1000, before?: signature }]` |
| **代码** | `alchemy_client.get_signatures_for_address` → `AlchemyRpc.rpc_post` |

**请求体示例**：

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "getSignaturesForAddress",
  "params": ["<代币_mint_地址>", {"limit": 1000, "before": "<上一页最后一条signature>"}]
}
```

**返回**：`[{ signature, blockTime, err, ... }, ...]`（按时间倒序，最新在前）

**翻页逻辑**（`search_alpha_hunters`）：

- `target_time_window = start_time + SM_MAX_DELAY_SEC` (10800，即 3 小时)
- 每页取 `limit=1000`，`before=上一页最后一条 signature`
- 若 `batch_oldest (sigs[-1].blockTime) <= target_time_window` → 触达开盘区间，停止
- 最多翻 `MAX_BACKTRACK_PAGES` (30) 页

**窗口内签名**：`start_time <= blockTime <= target_time_window`

---

### 5.2 API 4：Helius fetch_parsed_transactions

| 项 | 值 |
|----|-----|
| **URL** | `POST https://api.helius.xyz/v0/transactions?api-key={key}` |
| **请求体** | `{ "transactions": ["sig1", "sig2", ...] }` |
| **chunk_size** | 100（每批最多 100 笔，Helius 上限） |
| **超时** | 30s |

**解析数量**：取前 `SM_EARLY_TX_PARSE_LIMIT` (360) 笔签名（按 blockTime 升序后截取）

**返回**：Helius 增强格式，每笔含 `nativeTransfers`、`tokenTransfers`、`timestamp`/`blockTime` 等

---

### 5.3 初筛买家逻辑（不调 API）

对每笔解析后的交易：

```python
delay = blockTime - start_time
if delay < SM_MIN_DELAY_SEC (30): continue   # 排除开盘秒冲

# 合并 nativeTransfers + tokenTransfers(WSOL) + tokenTransfers(USDC按现价折算)
spend_by_addr[fromUserAccount] += amount

spender = max(spend_by_addr, key=spend_by_addr.get)
spend_sol = spend_by_addr[spender]

if spender in seen_buyers: continue
if SM_MIN_BUY_SOL (0.1) <= spend_sol <= SM_MAX_BUY_SOL (50):
    seen_buyers.add(spender)
    hunters_candidates.append({address, entry_delay, cost})  # entry_delay/cost 不入库
```

**USDC 价格**：`_get_usdc_price_sol` → 同 API 5，见下。

---

## 六、阶段 3：收益过滤 + 体检（逐候选人）

### 6.1 get_hunter_profit_on_token 流程

#### 6.1.1 频率预检（Alchemy）

| 调用 | 参数 | 说明 |
|------|------|------|
| `get_signatures(client, hunter_address, limit=100)` | 主钱包 | RECENT_TX_COUNT_FOR_FREQUENCY=100 |

**判定** `_is_frequent_trader_by_blocktimes(sigs)`：

| 条件 | 配置 | 结果 |
|------|------|------|
| 失败率 ≥ 30% | MAX_FAILURE_RATE_FOR_FREQUENCY | 否决 |
| 成功交易(err=null) < 10 笔 | MIN_SUCCESSFUL_TX_FOR_FREQUENCY | 否决 |
| 有效 blockTime 数 < 2 | - | 否决 |
| 成功交易平均间隔 < 300 秒 | MIN_AVG_TX_INTERVAL_SEC | 否决（高频） |

---

#### 6.1.2 ATA 精准拉取（Alchemy + 本地）

**ATA 推导**（无 RPC，本地 solders）：

```python
# utils/solana_ata.py
get_associated_token_address(owner, mint, "Token")      # 先试标准 SPL
get_associated_token_address(owner, mint, "Token2022")  # 无结果再试 Token-2022
```

**Alchemy 调用**（对 ATA 地址）：

| 调用 | 参数 | 说明 |
|------|------|------|
| `get_signatures(client, ata_address, limit=50)` | 猎手在该代币的 ATA | 通常 2~10 笔 |

---

#### 6.1.3 Helius 解析 ATA 签名

| 调用 | 说明 |
|------|------|
| `fetch_parsed_transactions(client, ata_sigs)` | 解析 ATA 的 2~10 笔签名 |

---

#### 6.1.4 LP 预检（不调 API）

遍历 `txs`，若 `tx_is_any_lp_behavior(tx)` 且涉及该 token → 淘汰并加入黑名单

---

#### 6.1.5 API 5：DexScreener 价格（USDC + 当前 token）

| 项 | 值 |
|----|-----|
| **URL** | `GET https://api.dexscreener.com/latest/dex/tokens/{token_address}` |
| **用途** | 1) USDC 价格（SOL 折算） 2) 未清仓时 token 现价 |

**价格解析**（`_get_token_price_sol`）：

- 遍历 pairs，仅保留 `chainId=="solana"` 的 token/SOL 或 SOL/token pair
- `priceNative`：quote per 1 base
- 若 token 为 base、quote 为 WSOL → 直接用 priceNative
- 若 token 为 quote、base 为 WSOL → `1/priceNative`

---

#### 6.1.6 ROI 计算（不调 API）

```
buy_sol, sell_sol, tokens_held = 从 ATA 交易汇总
total_value = sell_sol
if tokens_held > 0: total_value += tokens_held * 现价(DexScreener)
roi = (total_value - buy_sol) / buy_sol * 100
```

**门槛**：`roi < 100` 或 `buy_sol < 0.01` → 淘汰

**ATA 模式**：返回 `(roi, None)`，不复用 txs 给体检（ATA 仅含本代币）

---

### 6.2 analyze_hunter_performance 流程

#### 6.2.1 频率预检（若 pre_fetched_txs 为 None）

| 调用 | 参数 |
|------|------|
| `get_signatures(client, hunter_address, limit=SM_AUDIT_TX_LIMIT)` | limit=500 |

同 `_is_frequent_trader_by_blocktimes` 判定。

---

#### 6.2.2 Helius 解析主钱包交易

| 调用 | 说明 |
|------|------|
| `fetch_parsed_transactions(client, sigs)` | 解析 500 笔主钱包签名 |

---

#### 6.2.3 API 6：DexScreener USDC 价格

同 API 5，`token_address=USDC_MINT`，用于 USDC 流动折算 SOL。

---

#### 6.2.4 统计（不调 API）

```python
projects = _build_projects_from_txs(txs, exclude_token=当前代币, ...)

valid_projects = [p for p in projects if p.buy_sol > 0.05]

win_rate = len(盈利项目) / len(valid_projects)
total_profit = sum(profit)
avg_roi_pct = mean(roi)
pnl_ratio = total_wins / total_losses

max_roi_30d / max_roi_60d = 按时间窗口过滤 txs 后，单笔最大 ROI
```

**有效项目**：`buy_sol > 0.05` 的代币；`exclude_token` 排除当前挖掘代币。

---

## 七、体检（hunter_monitor）

### 7.1 run_immediate_audit（启动时）

对 `storage.hunters` 中每个猎手：

1. `analyze_hunter_performance(client, addr)` → 同上，Alchemy 500 笔 + Helius 解析 + DexScreener USDC
2. 判定踢出 / 更新
3. `asyncio.sleep(2)` 间隔

### 7.2 maintenance_loop（每 10 天）

1. **频繁交易剔除**：
   - `is_frequent_trader(client, addr)` → Alchemy `get_signatures(addr, limit=100)`
   - `_is_frequent_trader_by_blocktimes` 平均间隔 < 5 分钟 → 踢出

2. **体检过期**：`now - last_audit > AUDIT_EXPIRATION` (20 天)

3. **体检执行**：`analyze_hunter_performance(client, addr)`，同上

4. **踢出条件**：
   - `pnl_ratio < 2` 或 `win_rate < 0.2` 或 `total_profit <= 0`
   - `max_roi_30d < 50`

---

## 八、API 调用参数速查

### Alchemy RPC

| 方法 | 参数 | 挖掘用法 | 体检用法 |
|------|------|----------|----------|
| getSignaturesForAddress | address, limit, before? | 代币地址 limit=1000 翻页 | 主钱包 limit=500 |
| | | 主钱包 limit=100 频率预检 | 主钱包 limit=100 频率预检 |
| | | ATA limit=50 | - |

### Helius HTTP

| 端点 | 方法 | 请求体 | 挖掘 | 体检 |
|------|------|--------|------|------|
| /v0/transactions?api-key= | POST | `{transactions:[sig...]}` | 早期 360 笔、ATA 2~10 笔 | 主钱包 500 笔 |

### DexScreener

| 端点 | 挖掘 | 体检 |
|------|------|------|
| /latest/dex/tokens/{addr} | 年龄/涨幅、USDC 价、token 现价 | USDC 价（analyze 内） |

---

## 九、配置与常量速查

| 配置项 | 默认值 | 用途 |
|--------|--------|------|
| MIN_TOKEN_AGE_SEC | 1800 | 至少 30 分钟 |
| MAX_TOKEN_AGE_SEC | 21600 | 最多 6 小时 |
| DEX_MIN_24H_GAIN_PCT | 500 | 24h 涨幅 > 500% |
| MAX_BACKTRACK_PAGES | 30 | 回溯最多 30 页 |
| SM_EARLY_TX_PARSE_LIMIT | 360 | 早期最多解析 360 笔 |
| SM_MIN_DELAY_SEC | 30 | 开盘 30 秒后买入 |
| SM_MAX_DELAY_SEC | 10800 | 3 小时内买入 |
| SM_MIN_BUY_SOL / SM_MAX_BUY_SOL | 0.1 / 50 | 单笔买入 SOL |
| RECENT_TX_COUNT_FOR_FREQUENCY | 100 | 频率样本数 |
| MIN_SUCCESSFUL_TX_FOR_FREQUENCY | 10 | 成功交易最少 10 笔 |
| MAX_FAILURE_RATE_FOR_FREQUENCY | 0.30 | 失败率≥30% 否决 |
| MIN_AVG_TX_INTERVAL_SEC | 300 | 平均间隔<5分钟否决 |
| SM_AUDIT_TX_LIMIT | 500 | 体检拉 500 笔 |
| SM_MIN_TOKEN_PROFIT_PCT | 100 | 该代币 ROI≥100% |
| SM_ENTRY_MIN_PNL_RATIO | 2 | 入库盈亏比≥2 |
| SM_ENTRY_MIN_WIN_RATE | 0.2 | 入库胜率≥20% |
| SM_ENTRY_MIN_TRADE_COUNT | 10 | 入库有效代币≥10 |
| SM_AUDIT_MIN_PNL_RATIO | 2 | 体检踢出盈亏比<2 |
| SM_AUDIT_MIN_WIN_RATE | 0.2 | 体检踢出胜率<20% |
| TIER_THREE_ROI | 25 | 单token最大收益<25%不入库/体检踢出 |
| AUDIT_EXPIRATION | 20天 | 超过需重检 |
| MAINTENANCE_INTERVAL | 10天 | 维护间隔 |

---

## 十、单次挖掘 API 调用量估算（单个代币）

假设初筛 N 个候选人：

| API | 次数 | 说明 |
|-----|------|------|
| DexScreener 年龄/涨幅 | 1 | verify_token_age |
| Alchemy getSignatures 代币 | 1~30 | 翻页，最多 30 页 |
| Helius 解析早期 | 1 | 最多 360 笔，分批 100 |
| DexScreener USDC | 1 | 初筛时 |
| 每候选人： | | |
| Alchemy 主钱包 100 | N | 频率预检 |
| Alchemy ATA 50 | N×1~2 | Token + Token2022 |
| Helius ATA 解析 | N | 2~10 笔/人 |
| DexScreener token 价 | N×0~1 | 仅未清仓时 |
| DexScreener USDC | N | ROI 计算 |
| 每通过 ROI 的候选人： | | |
| Alchemy 主钱包 500 | M | 体检 |
| Helius 主钱包 500 | M | 体检 |
| DexScreener USDC | M | 体检 |

M = 通过 ROI≥100% 的候选人数量。
